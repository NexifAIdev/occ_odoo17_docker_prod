# ========================================
# CI/CD Deploy to DigitalOcean via SSH + Docker (Conditional)
# ========================================

name: CI/CD Deploy to DigitalOcean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------
      # 1) Check out the code
      # -----------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v3

      # -----------------------------------
      # 2) Determine which files changed
      # -----------------------------------
      - name: ğŸ” Determine changed files
        id: changes
        run: |
          DOCKER_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "docker-compose\.yml|Dockerfile|tomcat/" || true)
          CUSTOM_ADDONS_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "odoo/addons/custom" || true)

          if [ -n "$DOCKER_CHANGED" ]; then
            echo "docker_changed=true" >> $GITHUB_ENV
          else
            echo "docker_changed=false" >> $GITHUB_ENV
          fi

          if [ -n "$CUSTOM_ADDONS_CHANGED" ]; then
            echo "custom_addons_changed=true" >> $GITHUB_ENV
          else
            echo "custom_addons_changed=false" >> $GITHUB_ENV
          fi

      # -----------------------------------
      # 3) Securely copy files to DigitalOcean
      # -----------------------------------
      - name: ğŸ“¦ Copy files to DigitalOcean server
        uses: appleboy/scp-action@master
        with:
          host: 206.189.239.195
          username: root
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          source: "."
          target: "/root/occ_odoo17_docker"

      # -----------------------------------
      # 4) SSH into server and do conditional deploy
      # -----------------------------------
      - name: ğŸ” Conditional Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: 206.189.239.195
          username: root
          key: ${{ secrets.DO_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ“‚ Fixing filestore permissions..."
            cd /root/occ_odoo17_docker
            mkdir -p ./filestore
            chown -R 1000:1000 ./filestore
            chmod -R 777 ./filestore

            if [ "${{ env.docker_changed }}" = "true" ]; then
              echo "ğŸš€ Docker-related changes found â†’ Full rebuild!"
              docker-compose down -v
              docker-compose up -d --build
            elif [ "${{ env.custom_addons_changed }}" = "true" ]; then
              echo "â™»ï¸ Custom addons changed â†’ Updating all Odoo databases..."
              for db in $(docker exec occ-odoo17-web odoo --list-db); do
                echo "ğŸ” Updating DB: $db"
                docker exec occ-odoo17-web odoo -d "$db" -u all --stop-after-init || true
              done
              echo "ğŸ”„ Restarting Odoo..."
              docker restart occ-odoo17-web
            else
              echo "âœ… No changes requiring container restart. Done!"
            fi