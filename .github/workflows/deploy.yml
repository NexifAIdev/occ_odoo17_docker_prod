name: 🚀 CI/CD Deploy to DigitalOcean

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: 🔁 Deploy to DigitalOcean
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout source code
        uses: actions/checkout@v3

      - name: 🔍 Detect file changes
        id: detect_changes
        run: |
          echo "🔎 Checking for Docker or custom addon changes..."
          DOCKER_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "docker-compose\.yml|Dockerfile|tomcat/" || true)
          CUSTOM_ADDONS_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "odoo/addons/custom" || true)

          echo "docker_changed=${DOCKER_CHANGED:+true}" >> $GITHUB_ENV
          echo "custom_addons_changed=${CUSTOM_ADDONS_CHANGED:+true}" >> $GITHUB_ENV

      - name: 🔑 Set up SSH and copy files
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          mkdir -p ~/.ssh
          ssh-keyscan -H 178.128.107.59 >> ~/.ssh/known_hosts
          scp -i private_key.pem -r . root@178.128.107.59:/root/occ_odoo17_docker_prod
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

      - name: 🚀 Remote Deployment via SSH
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem root@178.128.107.59 << 'EOF'
            echo "📂 Fixing filestore permissions..."
            cd /root/occ_odoo17_docker_prod
            mkdir -p ./filestore
            chown -R 1000:1000 ./filestore
            chmod -R 777 ./filestore

            if [ "${{ env.docker_changed }}" = "true" ]; then
              echo "🚀 Docker-related changes found → rebuilding containers..."
              docker-compose down -v
              docker-compose up -d --build
            elif [ "${{ env.custom_addons_changed }}" = "true" ]; then
              echo "♻️ Custom addons changed → Updating all Odoo databases..."
              for db in $(docker exec occ-odoo17-web-prod odoo --list-db); do
                echo "🔁 Updating DB: $db"
                docker exec occ-odoo17-web-prod odoo -d "$db" -u all --stop-after-init || true
              done
            else
              echo "✅ No changes requiring container restart."
            fi
          EOF
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}